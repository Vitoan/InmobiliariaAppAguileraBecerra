@model IEnumerable<InmobiliariaAppAguileraBecerra.Models.Auditoria>

@{
ViewData["Title"] = "Auditoría del Sistema";
// Usar 'dynamic' para acceder a las propiedades de los filtros
var filtros = ViewData["Filtros"] as dynamic;
}

<div class="container mt-4">
<div class="d-flex justify-content-between align-items-center mb-3">
<h2 class="text-primary">
<i class="bi bi-shield-lock"></i> @ViewData["Title"]
</h2>
<a asp-controller="Home" asp-action="Index" class="btn btn-secondary">
<i class="bi bi-arrow-left-circle"></i> Volver al Inicio
</a>
</div>

<!-- Filtros -->
<form method="get" class="card shadow-sm mb-4 p-3">
    <div class="row g-3 align-items-end">
        
        @* --- Filtro: Tabla (CORRECCIÓN RZ1031 USANDO BLOQUES IF) --- *@
        <div class="col-md-3">
            <label class="form-label">Tabla</label>
            <select name="tabla" class="form-select">
                @if (filtros?.tabla == null || filtros?.tabla == "")
                {
                    <option value="" selected>Todas</option>
                }
                else
                {
                    <option value="">Todas</option>
                }
                
                @* Se usa la sintaxis IF/ELSE para imprimir la etiqueta OPTION completa *@
                @if (filtros?.tabla == "Contrato")
                {
                    <option value="Contrato" selected>Contrato</option>
                }
                else
                {
                    <option value="Contrato">Contrato</option>
                }
                
                @if (filtros?.tabla == "Pago")
                {
                    <option value="Pago" selected>Pago</option>
                }
                else
                {
                    <option value="Pago">Pago</option>
                }

                @if (filtros?.tabla == "Inmueble")
                {
                    <option value="Inmueble" selected>Inmueble</option>
                }
                else
                {
                    <option value="Inmueble">Inmueble</option>
                }

                @if (filtros?.tabla == "Inquilino")
                {
                    <option value="Inquilino" selected>Inquilino</option>
                }
                else
                {
                    <option value="Inquilino">Inquilino</option>
                }

                @if (filtros?.tabla == "Propietario")
                {
                    <option value="Propietario" selected>Propietario</option>
                }
                else
                {
                    <option value="Propietario">Propietario</option>
                }

            </select>
        </div>

        @* --- Filtro: Operación (CORRECCIÓN RZ1031 USANDO BLOQUES IF) --- *@
        <div class="col-md-3">
            <label class="form-label">Operación</label>
            <select name="operacion" class="form-select">
                @if (filtros?.operacion == null || filtros?.operacion == "")
                {
                    <option value="" selected>Todas</option>
                }
                else
                {
                    <option value="">Todas</option>
                }
                
                @* Se usa la sintaxis IF/ELSE para imprimir la etiqueta OPTION completa *@
                @if (filtros?.operacion == "Alta")
                {
                    <option value="Alta" selected>Alta</option>
                }
                else
                {
                    <option value="Alta">Alta</option>
                }

                @if (filtros?.operacion == "Modificación")
                {
                    <option value="Modificación" selected>Modificación</option>
                }
                else
                {
                    <option value="Modificación">Modificación</option>
                }

                @if (filtros?.operacion == "Baja")
                {
                    <option value="Baja" selected>Baja</option>
                }
                else
                {
                    <option value="Baja">Baja</option>
                }

                @if (filtros?.operacion == "Terminación")
                {
                    <option value="Terminación" selected>Terminación</option>
                }
                else
                {
                    <option value="Terminación">Terminación</option>
                }

                @if (filtros?.operacion == "Anulación")
                {
                    <option value="Anulación" selected>Anulación</option>
                }
                else
                {
                    <option value="Anulación">Anulación</option>
                }
                
            </select>
        </div>

        @* --- Filtro: Usuario (Sin cambios, ya era correcto) --- *@
        <div class="col-md-3">
            <label class="form-label">Usuario</label>
            <input type="text" name="usuario" class="form-control" placeholder="Buscar usuario..."
                    value="@filtros?.usuario" />
        </div>

        @* --- Filtro: Desde (Sin cambios, ya era correcto) --- *@
        <div class="col-md-3">
            <label class="form-label">Desde</label>
            <input type="date" name="desde" class="form-control"
                    value="@(filtros?.desde != null ? ((DateTime)filtros.desde).ToString("yyyy-MM-dd") : "")" />
        </div>

        @* --- Filtro: Hasta (Sin cambios, ya era correcto) --- *@
        <div class="col-md-3">
            <label class="form-label">Hasta</label>
            <input type="date" name="hasta" class="form-control"
                    value="@(filtros?.hasta != null ? ((DateTime)filtros.hasta).ToString("yyyy-MM-dd") : "")" />
        </div>

        <div class="col-md-12 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary me-2">
                <i class="bi bi-search"></i> Buscar
            </button>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Limpiar
            </a>
        </div>
    </div>
</form>

<!-- Tabla de resultados -->
<div class="card border-0 shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Fecha</th>
                        <th>Tabla</th>
                        <th>Operación</th>
                        <th>ID Registro</th>
                        <th>Usuario</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var a in Model)
                        {
                            <tr>
                                <td>@a.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                <td>@a.Tabla</td>
                                <td>
                                    @switch (a.Operacion)
                                    {
                                        case "Alta":
                                            <span class="badge bg-success">Alta</span>; break;
                                        case "Modificación":
                                            <span class="badge bg-warning text-dark">Modificación</span>; break;
                                        case "Baja":
                                            <span class="badge bg-danger">Baja</span>; break;
                                        case "Terminación":
                                            <span class="badge bg-info">Terminación</span>; break;
                                        case "Anulación":
                                            <span class="badge bg-secondary">Anulación</span>; break;
                                        default:
                                            <span class="badge bg-primary">@a.Operacion</span>; break;
                                    }
                                </td>
                                <td>@a.RegistroId</td>
                                <td>@a.Usuario</td>
                                <td>
                                    <a asp-action="Detalles" asp-route-id="@a.Id" class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-eye"></i> Ver
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <i class="bi bi-info-circle"></i> No se encontraron registros de auditoría.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>


</div>

<style>
.table th, .table td {
vertical-align: middle;
}

.form-label {
    font-weight: 500;
}

.badge {
    font-size: 0.85rem;
}


</style>