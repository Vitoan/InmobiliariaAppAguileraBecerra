@using InmobiliariaAppAguileraBecerra.Models
@model InmobiliariaAppAguileraBecerra.Models.Inmueble

@{
    var Id = Model?.Id ?? 0;
    ViewData["Title"] = Id > 0 ? "Editar Inmueble" : "Nuevo Inmueble";
}

<h1>@ViewData["Title"]</h1>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Guardar">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="form-group">
                <label asp-for="Id" class="control-label"></label>
                <input asp-for="Id" class="form-control" readonly />
            </div>

            <div class="form-group">
                <label asp-for="Direccion" class="control-label"></label>
                <input asp-for="Direccion" class="form-control" />
            </div>

            <div class="form-group">
                <label asp-for="Ambientes" class="control-label"></label>
                <input asp-for="Ambientes" class="form-control" />
            </div>

            <div class="form-group">
                <label asp-for="Latitud" class="control-label"></label>
                <input asp-for="Latitud" class="form-control" />
            </div>

            <div class="form-group">
                <label asp-for="Longitud" class="control-label"></label>
                <input asp-for="Longitud" class="form-control" />
            </div>

            <div class="form-group">
                <label class="control-label">Propietario</label>
                <select asp-for="PropietarioId" class="form-control" asp-items="ViewBag.Propietarios"></select>
            </div>

            <div class="form-group">
                <input type="submit" value="Guardar" class="btn btn-primary" />
            </div>
        </form>
    </div>

    <div class="col-md-4">
        <div class="mt-4">
            <h4>Ubicación en el mapa</h4>
            <div id="mapa" style="height: 300px; width: 100%; border: 1px solid #ccc;"></div>
        </div>
    </div>
</div>

<div>
    <a asp-action="Index">Volver a la Lista</a>
</div>

@section Scripts {
<script type="text/javascript">
    const lat = @Model?.Latitud.ToString("0.######", System.Globalization.CultureInfo.InvariantCulture) ?? "0";
    const lng = @Model?.Longitud.ToString("0.######", System.Globalization.CultureInfo.InvariantCulture) ?? "0";
    const direccion = '@(Model?.Direccion ?? "")';

    $(document).ready(function() {
        if (lat !== "0" && lng !== "0") {
            const map = L.map('mapa').setView([lat, lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            L.marker([lat, lng]).addTo(map)
                .bindPopup(direccion || "Ubicación desconocida")
                .openPopup();
        } else {
            $('#mapa').html('<p class="text-muted p-3">Ubicación no disponible.</p>');
        }

        // -----------------------------------------------------------
        // Búsqueda de propietarios por AJAX (de momento no lo implementamos, pero la idea es usarlo).
        /*
        $('#Propietario').select2({
            language: "es",
            theme: 'bootstrap',
            placeholder: "Buscar propietario...",
            minimumInputLength: 3,
            maximumInputLength: 10,
            ajax: {
                delay: 250,
                dataType: "json",
                cache: true,
                url: function (params) {
                    let q = params.term ? encodeURIComponent(params.term) : "";
                    return `/Propietarios/Buscar/${q}`;
                },
                processResults: function (res) {
                    return {
                        results: res.datos.map(p => ({id: p.Id, text: `${p.Nombre} ${p.Apellido}`}))
                    };
                }
            }
        });

        var idOriginal = +"@Model?.PropietarioId";
        var textoOriginal = "@Model?.Duenio?.Nombre @Model?.Duenio?.Apellido";
        if (idOriginal && textoOriginal) {
            var option = new Option(textoOriginal, idOriginal, true, true);
            $("#Propietario").append(option).trigger('change');
        }
        */
        // -----------------------------------------------------------
    });
</script>
}
